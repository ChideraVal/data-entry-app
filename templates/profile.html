{% extends 'base.html' %}

{% block title %}
{% load static %}
<title>Account</title>
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block body %}
<div class="container" role="main">
    <header class="header">
        <div class="brand">
            <div class="av-logo">{{ request.user.username|first|upper }}</div>
            <div>
                <h1>{{ request.user }}</h1>
                <div class="subtitle">{{ request.user.role|capfirst }} • 
                    {% if request.user.is_active %}
                    Active
                    {% else %}
                    Inactive
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="actions">
            <!-- <label class="btn" title="Upload files">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden>
                        <path d="M12 3v12" stroke="#0f172a" stroke-width="1.6" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="#0f172a" stroke-width="1.6"
                            stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M7 11l5-6 5 6" stroke="#0f172a" stroke-width="1.6" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                    <span style="opacity:.95">Upload Files</span>
                    <input id="fileUpload" type="file" multiple />
                </label> -->

            <a href="{% url 'change_password' %}" class="btn btn-link">Change password</a>
            <a href="{% url 'logout' %}" class="btn btn-link" style="background-color: red; color: white;">Log out</a>


            <!-- <button id="scanBtn" class="btn btn-primary" title="Scan inbox & process with AI">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden>
                    <path d="M3 12h4" stroke="white" stroke-width="1.8" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M7 12a5 5 0 0 1 10 0" stroke="white" stroke-width="1.8" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M21 12h-2" stroke="white" stroke-width="1.8" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                Scan Email Inbox
            </button> -->
        </div>
    </header>

    <!-- Metrics -->
    <!-- <section class="metrics" aria-label="Key metrics">
        <div class="metric card">
            <div class="icon" style="background:linear-gradient(135deg,#7c3aed,#60a5fa)">D</div>
            <div style="flex:1">
                <div class="m-title">Documents processed this month</div>
                <div class="m-value" id="docsValue">—</div>
                <div class="progress" aria-hidden><i id="docsProgress" style="width:0%"></i></div>
            </div>
        </div>

        <div class="metric card">
            <div class="icon" style="background:linear-gradient(135deg,#06b6d4,#0891b2)">E</div>
            <div style="flex:1">
                <div class="m-title">Emails fetched & processed</div>
                <div class="m-value" id="emailsValue">—</div>
                <div class="progress" aria-hidden><i id="emailsProgress" style="width:0%"></i></div>
            </div>
        </div>

        <div class="metric card">
            <div class="icon" style="background:linear-gradient(135deg,#16a34a,#34d399)">O</div>
            <div style="flex:1">
                <div class="m-title">Data approved (parsed data)</div>
                <div class="m-value" id="ordersValue">—</div>
                <div class="progress" aria-hidden><i id="ordersProgress" style="width:0%"></i></div>
            </div>
        </div>
    </section> -->

    <!-- Main -->
    {% if not request.user.is_member %}
    <section class="main">
        <!-- Queue / List -->
        <div class="card">
            <!-- Title line above toolbar -->
            <div style="display:flex;gap:12px;align-items:center; margin-bottom:20px;">
                <div style="flex: 1;">
                    <h2 style="margin-bottom: 2px;">Manage Users</h2>
                    <div class="subtitle">Shows the user accounts you can manage.</div>
                </div>
                <button id="adduserBtn" class="btn btn-primary">Add User</button>
            </div>
            
            <div class="toolbar">
                <div></div> <!-- spacer -->

                <div style="display:flex;gap:12px;align-items:center;" class="toolbar-sub">
                    <div class="filters" role="tablist" aria-label="Status filters">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="true">Active</button>
                        <button class="filter-btn" data-filter="false">Inactive</button>
                    </div>

                    <div class="search">
                        <input id="search" placeholder="Search username, date..." aria-label="Search users" />
                        <button id="refreshBtn" class="btn btn-ghost" title="Refresh (UI)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden>
                                <path d="M20 7v6h-6" stroke="#0f172a" stroke-width="1.6" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M4 17a8 8 0 1 0 4-7.1" stroke="#0f172a" stroke-width="1.6"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="list" id="queueList" aria-live="polite">
                <!-- rows inserted by JS -->
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar card">
            <h3 style="margin-top:0">Summary</h3>
            <div class="small">Quick stats and helpful tips</div>

            <!-- <div class="stat">
                <div>Pending</div>
                <div id="countPending">0</div>
            </div> -->
            <div class="stat">
                <div>
                    Active users
                    <p class="small" style="margin: .4em 0;">Number of active users you can view and manage.</p>
                </div>
                <div id="countSuccess">0</div>
            </div>
            <div class="stat">
                <div>
                    Inactive users
                    <p class="small" style="margin: .4em 0;">Number of inactive users you can view and manage.</p>
                </div>
                <div id="countFailed">0</div>
            </div>
            <!-- <div class="stat">
                <div>Total active users
                    <p class="small" style="margin: .4em 0;">Number of all active users in your organization (you included), including users you cannot view and manage.</p>
                </div>
                <div id="countLimit">0/0</div>
            </div> -->
            
            <div style="margin-top:18px">
                <h4 style="margin:0 0 8px 0">Notes</h4>
                <div class="small"> • You can only 
                    view and manage users permitted by your role.
                    <!-- <br>
                    • Total active users in your organization cannot exceed your plan limit. Inactive users do 
                    not count towards your plan limit. -->
                    <br>
                    • Adding of user will fail if any existing user has the same username or password</div>
            </div>

            {% if request.user.is_super_admin %}
            <div style="margin-top:18px">
                <!-- <button id="bulkReprocessBtn" class="btn btn-link" style="width:100%">Reprocess All Failed</button> -->
                <a href="{% url 'view_audit_logs' %}" class="btn btn-link" style="width: 100%; margin-top: .5em;">View Audit Logs</a>
            </div>
            {% endif %}
        </aside>
    </section>
    {% endif %}

</div>

<!-- Delete confirmation modal (fallback) -->
<!-- <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
        <h4 id="modalTitle">Delete email</h4>
        <p id="modalMessage">Are you sure you want to delete this email and it's results? This action cannot be undone.
        </p>
        <div class="row">
            <button type="button" class="btn ghost" onclick="closeModal()">Cancel</button>
            <button id="modalConfirm" type="button" class="btn btn-delete">Delete</button>
        </div>
    </div>
</div> -->

<!-- Rename confirmation modal -->
<div id="modalRename" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
        <h4 id="modalTitle">Edit User</h4>
        <!-- <p id="modalMessage">Are you sure you want to delete this Upload and its results? This action cannot
            be undone.</p> -->
        <p style="margin: .5em 0; font-size: .9em; color: #222;">Username</p>
        <input type="text" id="usernameInput" maxlength="100" autocomplete="off" disabled>

        <div class="show-password" style="margin: .5em 0 .5em 0; display: flex; align-items: center;">
            <input type="checkbox" id="isactiveInput"/>
            <label for="isactiveInput" style="margin: .5em 0; font-size: .9em; color: #222;">Is Active</label>
        </div>

        <p style="margin: .5em 0; font-size: .9em; color: #222;">Role</p>
        <select id="roleInput">
            {% if request.user.is_super_admin %}
            <option value="admin">Admin</option>
            {% endif %}
            <option value="member">Member</option>
        </select>
        <div class="row">
            <button type="button" class="btn ghost" onclick="closeRenameModal()">Cancel</button>
            <button id="modalRenameConfirm" type="button" class="btn primary">Save Changes</button>
        </div>
    </div>
</div>

<!-- Add user modal -->
<div id="modalAdd" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
        <h4 id="modalTitle">Add User</h4>
        <!-- <p id="modalMessage">Are you sure you want to delete this Upload and its results? This action cannot
            be undone.</p> -->
        <p style="margin: .5em 0; font-size: .9em; color: #222;">Username</p>
        <input type="text" id="usernameInput-a" maxlength="100" autocomplete="off">

        <p style="margin: .5em 0; font-size: .9em; color: #222;">Password</p>
        <input type="password" id="passwordInput-a" maxlength="100" autocomplete="off">
        <p style="font-size: .8em;">Password must be at least 8 characters and is temporary, the user with the password must
            change it during first log in.
        </p>

        <p style="margin: .5em 0; font-size: .9em; color: #222;">Confirm Password</p>
        <input type="password" id="passwordconfirmInput-a" maxlength="100" autocomplete="off">

        <div class="show-password" style="margin: .5em 0 .5em 0; display: flex; align-items: center;">
            <input type="checkbox" id="isactiveInput-a" checked/>
            <label for="isactiveInput-a" style="margin: .5em 0; font-size: .9em; color: #222;">Is Active</label>
        </div>

        <p style="margin: .5em 0; font-size: .9em; color: #222;">Role</p>
        <select id="roleInput-a">
            {% if request.user.is_super_admin %}
            <option value="admin">Admin</option>
            {% endif %}
            <option value="member" selected>Member</option>
        </select>

        <div class="show-password" style="margin: .5em 0 .5em 0; display: flex; align-items: center;">
            <input type="checkbox" id="togglePassword"/>
            <label for="togglePassword" style="margin: .5em 0; font-size: .9em; color: #222;">Show password</label>
        </div>

        <div class="row">
            <button type="button" class="btn ghost" onclick="closeAddModal()">Cancel</button>
            <button id="modalAddConfirm" type="button" class="btn primary">Add User</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>
{% endblock %}


{% block scripts %}
<!-- <script>
    let env_id = Number("{{ env_id }}");
</script> -->
<script src="{% static 'scripts/profile.js' %}"></script>
{% endblock %}