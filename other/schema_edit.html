<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Schema Builder — Load / Edit (Fixed)</title>
    <style>
        /* Polished UI styles */
        body {
            font-family: Arial, sans-serif;
            background: #f5f7fa;
            margin: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .pane {
            width: 50%;
            background: white;
            border: 1px solid #e0e6ed;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.04);
        }

        h2,
        h3 {
            margin: 10px 0 16px;
        }

        .field-card,
        .nested-field-card {
            background: #fff;
            border: 1px solid #dfe6ef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
            transition: box-shadow .12s, border-color .12s;
        }

        .nested-field-card {
            margin-left: 18px;
            border-left: 4px solid #4a90e2;
        }

        .label {
            font-size: 13px;
            margin-bottom: 6px;
            opacity: 0.85;
            display: block;
        }

        input[type="text"],
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccd6e0;
            border-radius: 6px;
            margin-bottom: 8px;
            box-sizing: border-box;
        }

        textarea {
            min-height: 120px;
            font-family: monospace;
            resize: vertical;
        }

        .controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            background: #2f6fed;
            color: white;
            cursor: pointer;
        }

        button.small {
            padding: 6px 8px;
            font-size: 13px;
        }

        button.ghost {
            background: transparent;
            color: #2f6fed;
            border: 1px solid #d6e0ff;
        }

        button.remove {
            background: #e05353;
        }

        button.remove:hover {
            background: #c34141;
        }

        .section-label {
            font-size: 13px;
            margin: 8px 0;
            font-weight: 600;
            color: #3b4a66;
        }

        pre {
            background: #f0f3f7;
            padding: 12px;
            border-radius: 8px;
            height: 300px;
            overflow: auto;
        }

        .tree-node ul {
            list-style: none;
            padding-left: 18px;
            margin: 6px 0;
        }

        .tree-node li {
            margin: 4px 0;
            font-size: 14px;
        }

        .errors {
            background: #fff6f6;
            border: 1px solid #ffd6d6;
            color: #9b2b2b;
            padding: 10px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .invalid {
            border-color: #e05252 !important;
            box-shadow: 0 2px 8px rgba(224, 82, 82, 0.08);
        }

        .status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            display: none;
        }

        .status.success {
            background: #edf7ee;
            color: #1f7a3a;
            border: 1px solid #bfe6bf;
            display: block;
        }

        .status.error {
            background: #fff3f3;
            color: #a22a2a;
            border: 1px solid #f5c7c7;
            display: block;
        }

        .save-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 12px;
        }

        .save-btn[disabled] {
            background: #9bb5f6;
            cursor: not-allowed;
        }

        .controls-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .select {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccd6e0;
            background: white;
        }

        .small-muted {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }
    </style>
</head>

<body>

    <h2>Schema Builder — Load / Edit (Fixed)</h2>

    <div class="container">
        <!-- Left pane: controls + builder -->
        <div class="pane">
            <h3>Load / Edit Schema</h3>

            <!-- Load from server -->
            <div class="section-label">Load saved schema</div>
            <div class="controls-row">
                <select id="schemaList" class="select"></select>
                <button class="small" onclick="refreshSchemaList()">Refresh</button>
                <button class="ghost small" onclick="loadSelectedSchema()">Load</button>
            </div>
            <div class="small-muted">Select a saved schema (belongs to current user) and click Load.</div>

            <hr>

            <!-- Paste JSON to load -->
            <div class="section-label">Paste typed JSON (for Pydantic)</div>
            <textarea id="pasteSchema"
                placeholder='Paste typed JSON here, e.g. {"supplier":"string","items":{"type":"array","items":{"sku":"string"}}}'></textarea>
            <div class="controls" style="margin-bottom:8px;">
                <button onclick="loadFromTextarea()">Load pasted JSON</button>
                <button class="ghost" onclick="clearPaste()">Clear textarea</button>
            </div>
            <div class="small-muted">Useful for quick tests. JSON must be the typed JSON format used for Pydantic
                generation.</div>

            <hr>

            <label class="label">Schema name</label>
            <input id="schemaName" type="text" placeholder="InvoiceData" oninput="renderAndValidate()" />

            <div class="section-label">Fields</div>
            <div id="fieldsContainer"></div>

            <div class="controls" style="margin-top:8px;">
                <button onclick="addField()">+ Add top-level field</button>
                <button class="ghost" onclick="clearAll()">Clear</button>
            </div>

            <div id="validationErrors"></div>

            <div class="save-row">
                <button id="saveBtn" onclick="saveSchema()" class="small" disabled>Save Schema</button>
                <div id="saveStatus" class="status"></div>
            </div>

            <div style="margin-top:8px; font-size:13px; color:#555;">
                The UI sends form data to the backend (`schema_name`, `schema_json`). Default URLs are editable in the
                top of the script.
            </div>
        </div>

        <!-- Right pane: previews -->
        <div class="pane">
            <h3>Typed JSON (for Pydantic generation)</h3>
            <pre id="jsonPreview">{}</pre>

            <h3 style="margin-top:12px;">Schema Tree</h3>
            <div id="treePreview" class="tree-node"></div>
        </div>
    </div>

    <script>
        /* ================== CONFIG ==================
           Update these constants to match your Django endpoints.
           LIST_URL -> GET, returns list [{id, name}, ...]
           GET_URL  -> GET?id=<id>, returns { schema_name, schema_json }
           SAVE_URL -> POST form-data 'schema_name', 'schema_json'
        */
        const LIST_URL = '/schemas/list/';
        const GET_URL = '/schemas/get/';
        const SAVE_URL = '/schemas/save/';

        /* ================== Utilities ================== */
        function uid(p = 'id') { return p + "_" + Math.random().toString(36).slice(2, 9); }
        function qs(sel, el = document) { return el.querySelector(sel); }
        function qsa(sel, el = document) { return Array.from(el.querySelectorAll(sel)); }
        function showStatus(msg, ok = true) { const s = document.getElementById('saveStatus'); s.style.display = 'block'; s.className = 'status ' + (ok ? 'success' : 'error'); s.textContent = msg; }

        /* ================== DOM refs ================== */
        const rootContainer = document.getElementById('fieldsContainer');
        const jsonPreview = document.getElementById('jsonPreview');
        const treePreview = document.getElementById('treePreview');
        const validationErrors = document.getElementById('validationErrors');
        const saveBtn = document.getElementById('saveBtn');
        const schemaList = document.getElementById('schemaList');
        const pasteSchema = document.getElementById('pasteSchema');

        /* ================== Field element factory ================== */
        function createFieldElement(isNested = false) {
            const id = uid('f');
            const wrapper = document.createElement('div');
            wrapper.id = id;
            wrapper.className = isNested ? 'nested-field-card' : 'field-card';
            wrapper.innerHTML = `
    <label class="label">Field name</label>
    <input class="fname" type="text" placeholder="field_name" oninput="renderAndValidate()" />

    <label class="label">Field type</label>
    <select class="ftype" onchange="onTypeChange('${id}')">
      <option value="string">string</option>
      <option value="integer">integer</option>
      <option value="number">number</option>
      <option value="boolean">boolean</option>
      <option value="object">object</option>
      <option value="array">array</option>
    </select>

    <div style="margin-top:8px;">
      <button class="small" onclick="removeElement('${id}')">Remove</button>
    </div>

    <div class="object-config" style="display:none; margin-top:10px;">
      <div class="section-label">Object fields</div>
      <div class="object-fields"></div>
      <div style="margin-top:8px;">
        <button class="small" onclick="addNestedField('${id}'); return false;">+ Add object field</button>
      </div>
    </div>

    <div class="array-config" style="display:none; margin-top:10px;">
      <label class="label">Array item type</label>
      <select class="arrayItemType" onchange="onArrayItemTypeChange('${id}')">
        <option value="string">string</option>
        <option value="integer">integer</option>
        <option value="number">number</option>
        <option value="boolean">boolean</option>
        <option value="object">object</option>
      </select>

      <div class="array-object-config" style="display:none; margin-top:8px;">
        <div class="section-label">Array item object fields</div>
        <div class="array-object-fields"></div>
        <div style="margin-top:8px;">
          <button class="small" onclick="addNestedArrayField('${id}'); return false;">+ Add array item field</button>
        </div>
      </div>
    </div>
  `;
            return wrapper;
        }

        /* ================== Add / Remove helpers ================== */
        function addField() { rootContainer.appendChild(createFieldElement(false)); renderAndValidate(); }
        function removeElement(id) { const el = document.getElementById(id); if (el) el.remove(); renderAndValidate(); }
        function addNestedField(parentId) { const parent = document.getElementById(parentId); parent.querySelector('.object-fields').appendChild(createFieldElement(true)); renderAndValidate(); }
        function addNestedArrayField(parentId) { const parent = document.getElementById(parentId); parent.querySelector('.array-object-fields').appendChild(createFieldElement(true)); renderAndValidate(); }

        /* ================== Type change handlers ================== */
        function onTypeChange(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const t = el.querySelector('.ftype').value;
            el.querySelector('.object-config').style.display = (t === 'object') ? 'block' : 'none';
            el.querySelector('.array-config').style.display = (t === 'array') ? 'block' : 'none';
            if (t === 'array') onArrayItemTypeChange(id);
            renderAndValidate();
        }
        function onArrayItemTypeChange(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const it = el.querySelector('.arrayItemType').value;
            el.querySelector('.array-object-config').style.display = (it === 'object') ? 'block' : 'none';
            renderAndValidate();
        }

        /* ================== Build typed JSON recursively ================== */
        function buildTypedFromElement(fieldEl) {
            const name = (qs('.fname', fieldEl)?.value || '').trim();
            if (!name) return null;
            const type = qs('.ftype', fieldEl).value;

            if (type === 'object') {
                const props = {};
                qsa(':scope > .object-config > .object-fields > .nested-field-card', fieldEl).forEach(nf => {
                    const child = buildTypedFromElement(nf);
                    if (child) props[child.name] = child.value;
                });
                return { name, value: { type: 'object', properties: props } };
            }

            if (type === 'array') {
                const itemType = qs('.arrayItemType', fieldEl).value;
                if (itemType === 'object') {
                    const arrProps = {};
                    qsa(':scope > .array-config > .array-object-config > .array-object-fields > .nested-field-card', fieldEl).forEach(nf => {
                        const child = buildTypedFromElement(nf);
                        if (child) arrProps[child.name] = child.value;
                    });
                    return { name, value: { type: 'array', items: { type: 'object', properties: arrProps } } };
                } else {
                    return { name, value: { type: 'array', items: (itemType === 'number' ? 'float' : itemType) } };
                }
            }

            return { name, value: (type === 'number' ? 'float' : type) };
        }

        /* ================== Validation ================== */
        function validateElement(fieldEl, path) {
            const errs = [];
            const name = (qs('.fname', fieldEl)?.value || '').trim();
            const displayPath = path || 'root';

            if (!name) {
                errs.push(`${displayPath}: field name cannot be empty.`);
                fieldEl.classList.add('invalid');
                return errs;
            }
            fieldEl.classList.remove('invalid');
            const type = qs('.ftype', fieldEl).value;

            if (type === 'object') {
                const nested = qsa(':scope > .object-config > .object-fields > .nested-field-card', fieldEl);
                if (nested.length === 0) {
                    errs.push(`${displayPath}.${name}: object must have at least one property.`);
                    fieldEl.classList.add('invalid');
                } else {
                    nested.forEach(nf => errs.push(...validateElement(nf, `${displayPath}.${name}`)));
                }
            } else if (type === 'array') {
                const itemType = qs('.arrayItemType', fieldEl).value;
                if (itemType === 'object') {
                    const nested = qsa(':scope > .array-config > .array-object-config > .array-object-fields > .nested-field-card', fieldEl);
                    if (nested.length === 0) {
                        errs.push(`${displayPath}.${name}: array item object must have at least one property.`);
                        fieldEl.classList.add('invalid');
                    } else {
                        nested.forEach(nf => errs.push(...validateElement(nf, `${displayPath}.${name}[]`)));
                    }
                }
            }
            return errs;
        }

        function validateEntireSchema() {
            const errors = [];
            const schemaName = document.getElementById('schemaName').value.trim();
            if (!schemaName) errors.push('Schema name cannot be empty.');

            const topFields = qsa(':scope > .field-card', rootContainer);
            if (topFields.length === 0) errors.push('Schema must have at least one top-level field.');

            topFields.forEach(f => errors.push(...validateElement(f, 'root')));
            return errors.filter(Boolean);
        }

        /* ================== Render & Validate ================== */
        function renderAndValidate() {
            // clear previous invalid flags
            qsa('.invalid').forEach(el => el.classList.remove('invalid'));

            // build typed JSON
            const typed = {};
            qsa(':scope > .field-card', rootContainer).forEach(f => {
                const r = buildTypedFromElement(f);
                if (r) typed[r.name] = r.value;
            });
            jsonPreview.textContent = JSON.stringify(typed, null, 4);

            // tree view
            treePreview.innerHTML = '';
            const ul = document.createElement('ul');
            for (const k in typed) ul.appendChild(buildTree(typed[k], k));
            treePreview.appendChild(ul);

            // validation
            const errs = validateEntireSchema();
            if (errs.length) {
                validationErrors.innerHTML = `<div class="errors"><b>Validation errors</b><ul>${errs.map(e => `<li>${e}</li>`).join('')}</ul></div>`;
                saveBtn.disabled = true;
            } else {
                validationErrors.innerHTML = '';
                saveBtn.disabled = false;
            }

            // hide save status while editing
            document.getElementById('saveStatus').style.display = 'none';
        }

        /* ================== Tree builder ================== */
        function buildTree(node, name) {
            const li = document.createElement('li');
            if (typeof node === 'object' && !Array.isArray(node)) {
                if (node.type === 'object') {
                    li.innerHTML = `<b>${name}</b> : object`;
                    const ul = document.createElement('ul');
                    for (const k in node.properties) ul.appendChild(buildTree(node.properties[k], k));
                    li.appendChild(ul);
                } else if (node.type === 'array') {
                    li.innerHTML = `<b>${name}</b> : array`;
                    const ul = document.createElement('ul');
                    const items = node.items;
                    if (typeof items === 'object' && items.type === 'object') {
                        for (const k in items.properties) ul.appendChild(buildTree(items.properties[k], k));
                    } else {
                        const child = document.createElement('li');
                        child.textContent = `items: ${items}`;
                        ul.appendChild(child);
                    }
                    li.appendChild(ul);
                } else {
                    li.textContent = `${name} : ${node}`;
                }
            } else {
                li.textContent = `${name} : ${node}`;
            }
            return li;
        }

        /* ================== CSRF helper ================== */
        function getCookie(name) {
            const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return v ? v.pop() : '';
        }

        /* ================== Save schema (POST) ================== */
        async function saveSchema() {
            const errs = validateEntireSchema();
            if (errs.length) {
                validationErrors.innerHTML = `<div class="errors"><b>Validation errors</b><ul>${errs.map(e => `<li>${e}</li>`).join('')}</ul></div>`;
                return;
            }

            const typed = {};
            qsa(':scope > .field-card', rootContainer).forEach(f => {
                const r = buildTypedFromElement(f);
                if (r) typed[r.name] = r.value;
            });

            const schemaName = document.getElementById('schemaName').value.trim();
            const fd = new FormData();
            fd.append('schema_name', schemaName);
            fd.append('schema_json', JSON.stringify(typed));

            saveBtn.disabled = true;
            showStatus('Saving...', true);

            try {
                const res = await fetch(SAVE_URL, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') || '' },
                    credentials: 'include',
                    body: fd
                });

                if (!res.ok) {
                    const txt = await res.text().catch(() => res.statusText);
                    showStatus(`Save failed: ${res.status} ${res.statusText} — ${txt}`, false);
                    saveBtn.disabled = false;
                    return;
                }

                await res.json().catch(() => null);
                showStatus('Saved successfully.', true);
                await refreshSchemaList();
                saveBtn.disabled = false;
            } catch (err) {
                showStatus(`Save error: ${err.message}`, false);
                saveBtn.disabled = false;
            }
        }

        /* ================== Load from textarea ================== */
        function clearPaste() { pasteSchema.value = ''; }
        function loadFromTextarea() {
            const raw = pasteSchema.value.trim();
            if (!raw) { showStatus('Paste area is empty', false); return; }

            let parsed;
            try { parsed = JSON.parse(raw); }
            catch (e) { showStatus('Invalid JSON in paste area: ' + e.message, false); return; }

            try {
                loadTypedJSONIntoUI(parsed);
                showStatus('Loaded pasted schema into builder', true);
            } catch (e) {
                showStatus('Failed to load pasted schema: ' + e.message, false);
            }
        }

        /* ================== Fixed loader: loadTypedJSONIntoUI ================== */
        /**
         * typed: object mapping fieldName -> definition
         * definition:
         *  - "string" | "integer" | "float" | "boolean"
         *  - { type: "object", properties: { ... } }
         *  - { type: "array", items: <primitive string or { type: "object", properties: {...} } > }
         */
        function loadTypedJSONIntoUI(typed) {
            if (!typed || typeof typed !== 'object') {
                throw new Error('Typed JSON must be an object mapping field -> type/object/array');
            }

            // clear builder
            rootContainer.innerHTML = '';

            // Recursive populater: parentContainer is DOM element to append into.
            function populate(parentContainer, keyName, def) {
                const el = createFieldElement(parentContainer !== rootContainer);
                el.querySelector('.fname').value = keyName;

                function setPrimitiveTypeOnEl(t) {
                    const mapped = (t === 'float' ? 'number' : t);
                    if (['string', 'integer', 'number', 'boolean'].includes(mapped)) {
                        el.querySelector('.ftype').value = mapped;
                    } else {
                        el.querySelector('.ftype').value = 'string';
                    }
                }

                // primitive
                if (typeof def === 'string') {
                    setPrimitiveTypeOnEl(def);
                    parentContainer.appendChild(el);
                    return;
                }

                // object schema
                if (def && typeof def === 'object' && def.type === 'object') {
                    el.querySelector('.ftype').value = 'object';
                    el.querySelector('.object-config').style.display = 'block';
                    const props = def.properties || {};
                    for (const childName of Object.keys(props)) {
                        populate(el.querySelector('.object-fields'), childName, props[childName]);
                    }
                    parentContainer.appendChild(el);
                    return;
                }

                // array schema
                if (def && typeof def === 'object' && def.type === 'array') {
                    el.querySelector('.ftype').value = 'array';
                    el.querySelector('.array-config').style.display = 'block';
                    const items = def.items;

                    if (typeof items === 'string') {
                        el.querySelector('.arrayItemType').value = (items === 'float' ? 'number' : items);
                        el.querySelector('.array-object-config').style.display = 'none';
                        parentContainer.appendChild(el);
                        return;
                    }

                    if (items && typeof items === 'object' && items.type === 'object') {
                        el.querySelector('.arrayItemType').value = 'object';
                        el.querySelector('.array-object-config').style.display = 'block';
                        const props = items.properties || {};
                        for (const childName of Object.keys(props)) {
                            populate(el.querySelector('.array-object-fields'), childName, props[childName]);
                        }
                        parentContainer.appendChild(el);
                        return;
                    }

                    // fallback: items may be { type: 'number' } style or others
                    if (items && typeof items === 'object' && typeof items.type === 'string') {
                        const maybe = (items.type === 'float' ? 'number' : items.type);
                        if (['string', 'integer', 'number', 'boolean'].includes(maybe)) {
                            el.querySelector('.arrayItemType').value = maybe;
                            el.querySelector('.array-object-config').style.display = 'none';
                            parentContainer.appendChild(el);
                            return;
                        }
                    }

                    // default fallback: array of string
                    el.querySelector('.arrayItemType').value = 'string';
                    el.querySelector('.array-object-config').style.display = 'none';
                    parentContainer.appendChild(el);
                    return;
                }

                // def may be { type: 'number' } etc.
                if (def && typeof def === 'object' && typeof def.type === 'string') {
                    const t = def.type === 'float' ? 'number' : def.type;
                    if (['string', 'integer', 'number', 'boolean'].includes(t)) {
                        el.querySelector('.ftype').value = t;
                        parentContainer.appendChild(el);
                        return;
                    }
                }

                // fallback
                el.querySelector('.ftype').value = 'string';
                parentContainer.appendChild(el);
            }

            // populate top-level
            for (const keyName of Object.keys(typed)) {
                populate(rootContainer, keyName, typed[keyName]);
            }

            // re-run render & validate
            renderAndValidate();
        }

        /* ================== Server: schema list & load ================== */
        async function refreshSchemaList() {
            schemaList.innerHTML = '';
            const opt = document.createElement('option');
            opt.textContent = 'Loading...';
            schemaList.appendChild(opt);

            try {
                const res = await fetch(LIST_URL, { credentials: 'include' });
                if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
                const list = await res.json();
                schemaList.innerHTML = '';
                if (Array.isArray(list) && list.length) {
                    list.forEach(item => {
                        const o = document.createElement('option');
                        o.value = item.id;
                        o.textContent = item.name || `Schema ${item.id}`;
                        schemaList.appendChild(o);
                    });
                } else {
                    const o = document.createElement('option');
                    o.textContent = '-- no saved schemas --';
                    o.value = '';
                    schemaList.appendChild(o);
                }
                showStatus('Schema list refreshed', true);
            } catch (err) {
                schemaList.innerHTML = '';
                const o = document.createElement('option');
                o.textContent = '-- failed to load --';
                o.value = '';
                schemaList.appendChild(o);
                showStatus('Failed to refresh schema list: ' + err.message, false);
            }
        }

        /* Load selected schema by id */
        async function loadSelectedSchema() {
            const id = schemaList.value;
            if (!id) { showStatus('No schema selected', false); return; }

            try {
                const res = await fetch(`${GET_URL}?id=${encodeURIComponent(id)}`, { credentials: 'include' });
                if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
                const payload = await res.json();
                const name = payload.schema_name || payload.name || '';
                let typed = payload.schema_json || payload.schema || null;
                if (typeof typed === 'string') typed = JSON.parse(typed);
                if (!typed || typeof typed !== 'object') throw new Error('Server returned invalid schema_json');

                document.getElementById('schemaName').value = name;
                loadTypedJSONIntoUI(typed);
                showStatus('Loaded schema from server', true);
            } catch (err) {
                showStatus('Failed to load schema: ' + err.message, false);
            }
        }

        /* ============== Misc helpers & init ============== */
        function clearPaste() { pasteSchema.value = ''; }
        function getCookie(name) { const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return v ? v.pop() : ''; }
        function renderInitial() { renderAndValidate(); refreshSchemaList(); }

        /* init */
        renderInitial();
    </script>
</body>

</html>